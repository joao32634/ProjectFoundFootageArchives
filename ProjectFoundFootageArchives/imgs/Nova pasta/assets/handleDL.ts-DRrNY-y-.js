function u(){window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader: No Quota",message:"Free quota is not enough, you can upgrade account(<strong>3 days free trial</strong>) now.",html:!0,hideCloseBtn:!1,buttons:[{text:"Upgrade",onclickEvent:"TO_SUBSCRIBE",closeOnClick:!0}]}}})),window.dispatchEvent(new CustomEvent("taskProcessed"))}window.addEventListener("invokeTasks",async n=>{const{detail:a}=n;let{userState:e}=await chrome.storage.local.get("userState");e=e?typeof e=="string"?JSON.parse(e):e:!1;let o=e?e.quota:0;const i=e&&e.isPro,r=e&&e.token!=="";if(!r){const{freeQuota:t}=await chrome.storage.local.get("freeQuota");t!==void 0?o=t:(chrome.storage.local.set({freeQuota:2}),o=2)}if(!i&&o<=0){u();return}const l=a;if(l.some(t=>t.signature)&&window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader",message:"It contains DRM protected resources, use the desktop app to download?",html:!1,hideCloseBtn:!0,buttons:[{title:"Ignore",closeOnClick:!0},{title:"Get Desktop App",onclickEvent:"TO_HOMESITE",closeOnClick:!0}]}}})),!r)chrome.storage.local.set({freeQuota:o-1});else if(!i&&!await chrome.runtime.sendMessage({command:"updateQuota"})){u();return}let c=!1;for(const t of l)if(!t.signature)try{const{setting:s}=await chrome.storage.local.get("settings"),p=(s==null?void 0:s.isSortByDate)??!1,m=new URL(t.url).pathname.split("/").pop(),d=[t.username,t.mediaType,m];p&&d.splice(1,0,t.dateString.split("T")[0]);const w=d.join("/");chrome.runtime.sendMessage({command:"Download",payload:{url:t.url,filename:w}}),c=!0}catch{window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader",message:"Something went wrong, please try again or contact support.",html:!1,hideCloseBtn:!0}}}))}c&&window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"toast",options:"Added to download list."}})),window.dispatchEvent(new CustomEvent("taskProcessed"))});window.addEventListener("alertConfirm",async n=>{const{detail:a}=n,{type:e}=a;e==="TO_SUBSCRIBE"&&chrome.runtime.sendMessage({command:"ToSubscription"}),e==="TO_HOMESITE"&&chrome.runtime.sendMessage({command:"ToHomesite"})});
